<!DOCTYPE html>
<html lang="en">
<head>
	<script src="/socket.io/socket.io.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script type="text/babel" >
        "use strict";


        let canvas;
        let ctx;

        let players = {};
        let ball = Object.seal({
            x: 0.5,
            y: 0.5,
            tx: 0,
            ty: 0,
            radius: 15,
            color: "orange"
        });
        let mouse = Object.seal({
            x: 0,
            y: 0
        });

    	const init = () => {
    		const socket = io.connect();

            socket.on("update", (data) => {
                updateObjects(data.ball, data.players);
            });

            socket.on("delete", (data) => {
                delete players[data];
            });

    		canvas = document.querySelector("canvas");
    		ctx = canvas.getContext("2d");

            canvas.width = 800;
            canvas.height = 600;


            canvas.onmousemove = (e) =>{
                mouse.x = e.offsetX;
                mouse.y = e.offsetY;
                socket.emit("update", mouse);
            }

            socket.emit("joinGame");


    		update();
    	};

    	window.onload = init;

    	const update = () => {
    		requestAnimationFrame(update);

    		ctx.clearRect(0,0, canvas.width, canvas.height);

            drawCircle(mouse.x, mouse.y, 5, "black");

            moveObjects();

            drawObjects();
    	};


        const updateObjects = (newBall, newPlayers) => {
            ball.tx = newBall.x;
            ball.ty = newBall.y;
            ball.color = newBall.color;

            let keys = Object.keys(newPlayers);
            for(let n = 0; n < keys.length; ++n){
                if(!players[keys[n]])
                    players[keys[n]] = {
                        x: newPlayers[keys[n]].x,
                        y: newPlayers[keys[n]].y,
                        radius: newPlayers[keys[n]].radius,
                        color: newPlayers[keys[n]].color
                    };
                players[keys[n]].tx = newPlayers[keys[n]].x;
                players[keys[n]].ty = newPlayers[keys[n]].y;
            }
        };

        const moveObjects = () => {
            const lerpVal = 0.2;

            ball.x += (ball.tx - ball.x) * lerpVal;
            ball.y += (ball.ty - ball.y) * lerpVal;

            let keys = Object.keys(players);
            for(let n = 0; n < keys.length; ++n){
                players[keys[n]].x += (players[keys[n]].tx - players[keys[n]].x) * lerpVal;
                players[keys[n]].y += (players[keys[n]].ty - players[keys[n]].y) * lerpVal;
            }
        };

        const drawObjects = () => {
            drawCircle(
                ball.x,
                ball.y,
                ball.radius,
                ball.color);

            let keys = Object.keys(players);
            for(let n = 0; n < keys.length; ++n){
                let p = players[keys[n]];
                drawCircle(
                p.x,
                p.y,
                p.radius,
                p.color);
            }
        };

        const drawCircle = (x,y,r,color) => {
            ctx.save();
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, 2*Math.PI);
            ctx.fill();
            ctx.restore();
        };




    </script>
    <title>Barasket Oballma</title>
</head>
<body>

Welcome to...<br>
BARASKET OBALLMA!<br>
A game of sports<br>

<canvas style="border: solid">Get a real browser!</canvas>

</body>
</html>